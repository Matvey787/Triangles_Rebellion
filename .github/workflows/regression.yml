name: Regression tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            g++ \
            clang++ \
            ninja-build \
            clang-tidy \
            libgtest-dev \
            libgmock-dev

      - name: Configure with CMake and Ninja
        working-directory: ./tests/GEOLib/tester
        run: |
          cmake -G Ninja \
                -S . \
                -B build \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DGTEST=ON \
                -DCTEST=ON \
                -DCMAKE_BUILD_TYPE=Debug

      - name: Build with Ninja
        working-directory: ./tests/GEOLib/tester
        run: cmake --build build -- -j$(nproc)

      - name: Run clang-tidy
        working-directory: ./tests/GEOLib/tester
        run: |
          if cmake --build build --target help | grep -q clang-tidy; then
            cmake --build build --target clang-tidy || true
          else
            echo "clang-tidy target not found, skipping..."
          fi

      - name: Run tests with gtest
        working-directory: ./tests/GEOLib/tester
        run: |
          if [ -f "./build/geo_tests" ]; then
            ./build/geo_tests --gtest_output=xml:test-results.xml
            TEST_EXIT_CODE=$?
            if [ $TEST_EXIT_CODE -ne 0 ]; then
              echo "âŒ GTest failed with exit code: $TEST_EXIT_CODE"
              exit 1
            fi
          else
            echo "âŒ Test executable not found!"
            exit 1
          fi

      - name: Run ctest for better reporting
        working-directory: ./tests/GEOLib/tester
        run: |
          if [ -d "./build" ]; then
            ctest --test-dir build -V --output-on-failure
            CTEST_EXIT_CODE=$?
            if [ $CTEST_EXIT_CODE -ne 0 ]; then
              echo "âŒ CTest failed with exit code: $CTEST_EXIT_CODE"
              exit 1
            fi
          else
            echo "âŒ Build directory not found!"
            exit 1
          fi

      - name: Upload test artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            tests/GEOLib/tester/test-results.xml
            tests/GEOLib/tester/build/Testing/**/*.xml

      - name: Upload test summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Build completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "tests/GEOLib/tester/test-results.xml" ]; then
            echo "**ðŸ“Š GTest Results:**" >> $GITHUB_STEP_SUMMARY

            tests=$(grep -o 'tests="[^"]*"' tests/GEOLib/tester/test-results.xml | head -1 | cut -d'"' -f2)
            FAILURES=$(grep -o 'failures="[^"]*"' tests/GEOLib/tester/test-results.xml | head -1 | cut -d'"' -f2)
            echo "- Total tests: $tests" >> $GITHUB_STEP_SUMMARY
            echo "- Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Generator: Ninja" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: clang++" >> $GITHUB_STEP_SUMMARY
          echo "- Build type: Debug" >> $GITHUB_STEP_SUMMARY
          echo "- GTest: ON" >> $GITHUB_STEP_SUMMARY
          echo "- CTest: ON" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Finished at $(date)" >> $GITHUB_STEP_SUMMARY
