name: Regression tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
    build-and-test:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
          
          - name: Giving permission to run the details folder
            run: chmod +x .github/workflows/details/*.sh

          - name: Installing project dependencies
            run: ./.github/workflows/details/install_deps.sh

          - name: Build & run gtests
            run: ./.github/workflows/details/tester_run_gtest.sh

          - name: Build projects for ctests
            run: ./.github/workflows/details/tester_create_exe_for_ctest.sh

          - name: Build & run ctests
            run: ./.github/workflows/details/tester_run_ctest.sh

          - name: Upload test summary
            if: always()
            run: |
              echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**âœ… Build completed successfully**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ -f "tests/GEOLib/tester/build/test-results.xml" ]; then
                  echo "**ðŸ“Š GTest Results:**" >> $GITHUB_STEP_SUMMARY

                  tests=$(grep -o 'tests="[^"]*"' tests/GEOLib/tester/build/test-results.xml | head -1 | cut -d'"' -f2)
                  FAILURES=$(grep -o 'failures="[^"]*"' tests/GEOLib/tester/build/test-results.xml | head -1 | cut -d'"' -f2)
                  echo "- Total tests: $tests" >> $GITHUB_STEP_SUMMARY
                  echo "- Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
              echo "- Generator: Ninja" >> $GITHUB_STEP_SUMMARY
              echo "- Compiler: clang++" >> $GITHUB_STEP_SUMMARY
              echo "- Build type: Debug" >> $GITHUB_STEP_SUMMARY
              echo "- GTest: ON" >> $GITHUB_STEP_SUMMARY
              echo "- CTest: ON" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Finished at $(date)" >> $GITHUB_STEP_SUMMARY
